---
layout: post
title: tiny6410开发板linux系统下的SPI驱动和测试
categories: 工作
tags: 嵌入式 tiny6410 linux
---



- Step0：配置内核文件加入spi支持.一定要加上”User mode SPI driver support”这个支持,如图.
![内核文件加入spi支持]({{ site.img_url }}/2013-12-29-spi-make-meunconfig.png)



- Step1：打开`arch/arm/mach_s3c64XX/mach_mini6410.c`
增加如下代码：


static void cs_set_level(unsigned line_id, int lvl) {

    gpio_direction_output(line_id, lvl);

}

static struct s3c64xx_spi_csinfo s3c64xx_spi0_csinfo = {
 
.fb_delay=100,

 .line=S3C64XX_GPC(3),
 
.set_level=cs_set_level,

};

static struct spi_board_info s3c6410_spi0_board[] = {

[0] = {

.modalias = "spidev",

.bus_num= 0,

.chip_select= 0,

.irq =IRQ_SPI0,

.max_speed_hz= 500*1000,

.mode=SPI_MODE_0,

.controller_data=&s3c64xx_spi0_csinfo,

},

};
static struct s3c64xx_spi_csinfo s3c64xx_spi1_csinfo = {
 .fb_delay=100,
 .line=S3C64XX_GPC(7),
 .set_level=cs_set_level,
};

static struct spi_board_info s3c6410_spi1_board[] = {

[0] = {

.modalias = "spidev",

.bus_num= 1,

.chip_select= 0,

.irq = IRQ_SPI1,

.max_speed_hz = 500*1000,

.mode=SPI_MODE_0,

.controller_data=&s3c64xx_spi1_csinfo,

},

};

找到mini6410_devices这个结构,加下面两行,

&s3c64xx_device_spi0,

&s3c64xx_device_spi1,
加入到mini6410_devices结构中，就可以将设备s3c64xx-spi.0和s3c64xx-spi.1进行初始化，

在函数 mini6410_machine_init中添加：


 s3c64xx_spi_set_info(0,0,2);

 s3c64xx_spi_set_info(1,0,2);

 spi_register_board_info(s3c6410_spi0_board, ARRAY_SIZE(s3c6410_spi0_board));

 spi_register_board_info(s3c6410_spi1_board, ARRAY_SIZE(s3c6410_spi1_board));




mach_mini6410.c头文件里面添加头文件

`#include <linux/spi/spidev.h>`

`#include <linux/spi/spi.h>`

`#include <plat/s3c64xx-spi.h>`

以后逐渐要做：

1. 把以前的blog挪过来。
2. 熟悉Markdown语法。
3. 选择适合自己的模板.
4. 争取每个月都写几篇blog.



